# -*- tab-width:2;indent-tabs-mode:t;show-trailing-whitespace:t;rm-trailing-spaces:t -*-
# vi: set ts=2 noet:
#
# (c) Copyright Rosetta Commons Member Institutions.
# (c) This file is part of the Rosetta software suite and is made available under license.
# (c) The Rosetta software is developed by the contributing members of the Rosetta Commons.
# (c) For more information, see http://www.rosettacommons.org. Questions about this can be
# (c) addressed to University of Washington CoMotion, email: license@uw.edu.

iscript_fname = "compare_sample_sources_iscript.R"

iscript_header <- function(){
  cat(paste(
"# -*- tab-width:2;indent-tabs-mode:t;show-trailing-whitespace:t;rm-trailing-spaces:t -*-
# vi: set ts=2 noet:
#
# (c) Copyright Rosetta Commons Member Institutions.
# (c) This file is part of the Rosetta software suite and is made available under license.
# (c) The Rosetta software is developed by the contributing members of the Rosetta Commons.
# (c) For more information, see http://www.rosettacommons.org. Questions about this can be
# (c) addressed to University of Washington CoMotion, email: license@uw.edu.

####################################################################
#                                                                  #
#     This script is auto-generated by compare_sample_sources.R    #
#                                                                  #
#                                                                  #
#  Use this to interactively develop or refine an analysis script  #
#                                                                  #
####################################################################


#
# To use, from with in R run:
#
#   source(\"",iscript_fname,"\")
#

", sep=""), file=iscript_fname, append=FALSE)
}

iscript_libraries <- function(libraries){
  for(lib in libraries){
    cat("library(", lib, ")\n", file=iscript_fname, sep="", append=TRUE)
  }
  cat("\n", file=iscript_fname, append=TRUE)
}

iscript_base_dir <- function(base_dir){
	cat("base_dir <- \"", base_dir , "\"\n", file=iscript_fname, sep="", append=T)
}

iscript_output_dir <- function(output_dir){
  cat("#directory where the output should be generated\n",
      file=iscript_fname, append=TRUE)
	cat("if(!file.exists(\"", output_dir, "\")){
	dir.create(\"", output_dir, "\", recursive=TRUE)
}\n", file=iscript_fname, sep="", append=TRUE)
  cat("sample_source_output_dir <- \"", output_dir, "\"\n",
      file=iscript_fname, sep="", append=TRUE)
  cat("\n", file=iscript_fname, append=TRUE)
}


iscript_includes <- function(base_dir, includes){
  for( inc in includes){
    cat("source(\"",base_dir, "/", inc, "\")\n", file=iscript_fname, sep="", append=TRUE)
  }
  cat("\n", file=iscript_fname, append=TRUE)
}

iscript_parallel_backend <- function(base_dir, ncores){
	cat(
		"#Should the analysis be run in parallel? If so, how many cores to use?\n",
		file=iscript_fname, append=TRUE)

	if(!is.null(ncores)){
		cat("registerDoMC(", ncores, ")\n", sep="", file=iscript_fname, append=TRUE)
		cat("use_parallel <- TRUE\n", file=iscript_fname, append=TRUE)
	} else {
		cat("use_parallel <- FALSE\n", file=iscript_fname, append=TRUE)
	}
}

iscript_summarize_configuration <- function(ss_cmp){
	cat(
		"## BEGIN SAMPLE SOURCE COMPARISON ##\n",
		file=iscript_fname, sep="", append=T)
}

iscript_sample_sources <- function(sample_sources){
	dump("sample_sources", file=iscript_fname, append=TRUE)
	cat("\n", file=iscript_fname, append=TRUE)
}

iscript_output_formats <- function(output_formats){
  cat("#file format for plots
#See scripts/methods/output_formats.csv for more formats\n",
      file=iscript_fname, append=TRUE)
	dump("output_formats", file=iscript_fname, append=TRUE)
  cat("\n", file=iscript_fname, append=TRUE)
}

iscript_setup_add_footer_to_output_formats <- function(add_footer){
	if(add_footer){
		cat("#Do not include footer information in any plots\n",
"output_formats$add_footer <- FALSE\n\n", sep="",
				file=iscript_fname, append=TRUE)
	} else {
		cat("#nclude footer information for the plot formats that can accept them\n",
"output_formats$add_footer <- output_formats$accept_footer\n\n", sep="",
				file=iscript_fname, append=TRUE)
	}
}


iscript_db_cache_size <- function(db_cache_size){
	cat(
  	"database_configuration <- list(\n",
		"	#number of 1k pages to use as cache\n",
		"	db_cache_size = ", db_cache_size, ")\n\n",
		file=iscript_fname, sep="", append=TRUE)
}

iscript_general_kernel_adjust <- function(general_kernel_adjust){
	cat("#Adjust density estimation kernel:\n",
"general_kernel_adjust <- ", general_kernel_adjust, "\n",
		file=iscript_fname, sep="", append=TRUE)
}

iscript_source_scripts <- function(base_dir, scripts){
  cat("\n", file=iscript_fname, append=TRUE)
  cat("#Source these analysis scripts:\n",
      file=iscript_fname, append=TRUE)
	cat("feature_analyses <- c()\n",
			file=iscript_fname, append=TRUE)
  for(script in scripts){
		if(file.exists(script)){
			# analysis script is ok
		} else if (file.exists(file.path(base_dir, script))){
			script <- file.path(base_dir, script)
		}

		cat("source(\"", script, "\")\n",
        file=iscript_fname, sep="", append=TRUE)
  }
}

iscript_run_feature_analyses <- function(output_dir){
  cat("\n", file=iscript_fname, append=TRUE)
	cat("#Run these feature_analyses:\n",
			file=iscript_fname, append=TRUE)
	cat("for(features_analysis in feature_analyses){

	cat(paste(\"Features Analysis: \", features_analysis@id, \"\\n\", sep=\"\"))


	# In order to assist in running the script interactively, rather
	# than just running it, setup the input parameters in the current
	# evironment and then evaluate the body of the function in the
	# current frame as well.

	setwd(\"", base_dir, "\")
	self <- features_analysis
	output_dir <- \"", output_dir, "\"
	eval(body(features_analysis@run))

	cat(\"\\n\")
}\n\n", sep="",
			file=iscript_fname, append=TRUE)
}
